(function(){function c(){this.db88UpdateInviteUrl=this.db88MemberIsLikeShopUrl=this.db88LikeCountUrl=this.db88LikeShopUrl="";this.isCreateMemberFromAutoLike=this.isSubscribe=this.isPendingLikeShop=this.isUpdateInviteBusy=this.isUpdateLikeCountBusy=this.isUpdateLikeStatusBusy=this.isLikeShopBusy=this.isMemberLogin=!1;this.onLikeShopComplete=this.likeCount=null}var e="unknown",f="unknown";c.prototype.autoLikeOnLoad=function(a,b){this.likeData=a;this.inviteInfo=b;var d=this;window.onload=function(){d.traceInviteInit(null);
var a=function(a){d.onLikeShopComplete=function(){d.traceInviteSuccess(null)};Shop88Event.publish("Shop88LikeButtonHandler.pendingLikeShop");d.isSubscribe=a.subscribe;Shop88Event.publish("sso.lazyCreateMember",{memberInfo:d.likeData,isAutoLogin:!0,onComplete:function(a){d.isCreateMemberFromAutoLike=a}})},b=function(){Shop88Event.publish("Shop88LikeConfirmDialog.open",{callback:a})};Member.getHasInit()?b(null,null):Shop88Event.subscribe("memberInfo.ready",b)}};c.prototype.traceInviteInit=function(a){this.updateInviteResponse("&tstate=1&likedata="+
encodeURIComponent(this.likeData)+"&targs="+encodeURIComponent(this.inviteInfo),a)};c.prototype.traceInviteSuccess=function(a){this.updateInviteResponse("&tstate=2&likedata="+encodeURIComponent(this.likeData)+"&targs="+encodeURIComponent(this.inviteInfo)+"&IsSubscribed="+(this.isSubscribe?"1":"0")+"&IsAutoCreateMember="+(this.isCreateMemberFromAutoLike?"1":"0"),a)};c.prototype.updateInviteResponse=function(a,b){if(!this.isUpdateInviteBusy){this.isUpdateInviteBusy=!0;var d=this;$.jsonp({url:this.db88UpdateInviteUrl+
a,complete:function(){d.isUpdateInviteBusy=!1;b&&"function"==typeof b&&b()}})}};c.prototype.init=function(){var a=this,b=function(b,d){a.isMemberLogin=a.checkIsMemberLogin(d.member);var c=null===a.likeCount;a.isMemberLogin?a.updateLikeStatus(c):c?a.updateLikeCount():a.publishLikeButtonChangeEvent("unknown",a.likeCount)},d=function(b){a.isSubscribe=b.subscribe;a.isMemberLogin?a.requestLikeShop():a.loginBeforeLike()};Shop88Event.subscribe("sso.statusChanged",b);Shop88Event.subscribe("memberInfo.ready",
b);Shop88Event.subscribe("Shop88LikeButtonHandler.likeShop",function(b,c){if(!a.isLikeShopBusy&&!this.isUpdateLikeStatusBusy&&!this.isUpdateLikeCountBusy){a.onLikeShopComplete=c&&c.onLikeShopComplete?c.onLikeShopComplete:null;var e;if(c&&c.greetingMsg)e=c.greetingMsg;Shop88Event.publish("Shop88LikeConfirmDialog.open",{callback:d,greetingMsg:e})}});Shop88Event.subscribe("Shop88LikeButtonHandler.pendingLikeShop",function(){a.isPendingLikeShop=!0});if(Member.getHasInit()){var c=Member.getMemberData();
b("",c)}};c.prototype.checkIsMemberLogin=function(a){return null!=(null==a?null:a.email)};c.prototype.loginBeforeLike=function(){Shop88Event.publish("sso.login",{profile:"like",loginSuccessCallback:function(){Shop88Event.publish("Shop88LikeButtonHandler.pendingLikeShop")}})};c.prototype.requestLikeShop=function(){if(!this.isLikeShopBusy){this.isLikeShopBusy=!0;Shop88Event.publish("loading.on");var a=this;$.jsonp({url:this.db88LikeShopUrl+(this.isSubscribe?"&Subscribe=1":"&Subscribe=0"),success:function(b){if(b)if("0"==
b.code||"11000"==b.code){if(b="0"==b.code?++a.likeCount:a.likeCount,a.publishLikeButtonChangeEvent("liked",b),null!=a.onLikeShopComplete)a.onLikeShopComplete()}else"-9"==b.code?(this.setIsLikeShop("unknown"),a.loginBeforeLike()):"1"==b.code?alertMessage("An Error Occurred","Update 88Shop like button status error.(Unsupported action)"):"3"==b.code?alertMessage("An Error Occurred","Update 88Shop like button status error.(Expected parameter not found)"):alertMessage("An Error Occurred","88Shop like button error code: "+
b.code);else alertMessage("An Error Occurred","88Shop like button error.")},error:function(){},complete:function(){a.isLikeShopBusy=!1;Shop88Event.publish("loading.off");a.onLikeShopComplete=null}})}};c.prototype.updateLikeStatus=function(a){if(!this.isUpdateLikeStatusBusy){this.isUpdateLikeStatusBusy=!0;var b=this;$.jsonp({url:this.db88MemberIsLikeShopUrl+(a?"&NC=1":""),success:function(a){if(a)if("0"==a.code){var c="1"==a.data.IsLikeShop?"liked":"unlike",a="undefined"!==typeof a.data.LikeCount?
parseInt(a.data.LikeCount,10):b.likeCount;b.publishLikeButtonChangeEvent(c,a);if(b.isPendingLikeShop)b.requestLikeShop(),b.isPendingLikeShop=!1}else"-9"==a.code?(this.setIsLikeShop("unknown"),b.updateLikeCount()):"1"==a.code?alertMessage("An Error Occurred","Update 88Shop like button status error.(Unsupported action)"):"3"==a.code?Shop88Event.publish("Shop88LikeButtonHandler.likeButtonUpdateFailed"):alertMessage("An Error Occurred","Update 88Shop like button status error.(Unknown error code: "+a.code+
")");else alertMessage("An Error Occurred","Update 88Shop like button status error.")},error:function(){},complete:function(){b.isUpdateLikeStatusBusy=!1}})}};c.prototype.updateLikeCount=function(){if(!this.isUpdateLikeCountBusy){this.isUpdateLikeCountBusy=!0;var a=this;$.jsonp({url:this.db88LikeCountUrl,success:function(b){if(b&&"0"==b.code){var c=e,b=parseInt(b.data.LikeCount,10);a.publishLikeButtonChangeEvent(c,b)}},error:function(){},complete:function(){a.isUpdateLikeCountBusy=!1}})}};c.prototype.publishLikeButtonChangeEvent=
function(a,b){if(e!=a){var c={};c.isLikeShop=a;c.previousLikeStatus=e;c.likeCount=this.likeCountRoundingToStr();Shop88Event.publish("Shop88LikeButtonHandler.likeStatusChange",c)}this.setIsLikeShop(a);this.likeCount=b;c={};c.isLikeShop=e;c.previousLikeStatus=f;c.likeCount=this.likeCountRoundingToStr();Shop88Event.publish("Shop88LikeButtonHandler.likeButtonUpdate",c)};c.prototype.likeCountRoundingToStr=function(){var a=this.likeCount,b="";!isNaN(a)&&0<=a&&(b=1E4>a?formatNumberByComma(a):formatNumberByComma(Math.floor(a/
1E3))+"k");return b};c.prototype.getLikeStatus=function(){return null===this.likeCount?(this.updateLikeCount(),null):{isLikeShop:e,likeCount:this.likeCount}};c.prototype.setIsLikeShop=function(a){f=e;e=a};window.Shop88LikeButtonHandler=c;c.getIsLikeShop=function(){return e};c.getPreviousIsLikeShop=function(){return f}})();
